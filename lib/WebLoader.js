var Path=require("./Path.js"),ilib=require("./ilib.js"),Loader=require("./Loader.js"),Locale=require("./Locale.js"),WebLoader=function(ilib,sync,onLoad){var base,pos,colon;this.parent.call(this,ilib),this._loadFile=-1<navigator.userAgent.indexOf(" .NET")?this._ieLoadFile:this._regularLoadFile;var scripts=document.getElementsByTagName("script");pos=window.location.href.lastIndexOf("html"),this.root=window.location.href.substring(0,pos),pos=this.root.lastIndexOf("/"),this.root=this.root.substring(0,pos),colon=this.root.indexOf("://"),this.root=Path.normalize(Path.join(this.root.substring(colon+3)));for(var i=0;i<scripts.length;i++){var source=scripts[i].src;if(source&&-1!==(pos=source.search(/\/ilib-[a-z\-]*\.js$/))){colon=source.indexOf("://"),this.protocol=source.substring(0,colon+3),base=Path.join(source.substring(colon+3,pos-1),"..");break}}this.base=Path.normalize(Path.join(base||this.root,"data")),this.includePath.push(Path.join(this.root,"resources")),this._exists(Path.join(base,"locale"),"localeinfo.json"),this._exists("/usr/share/javascript/ilib/locale","localeinfo.json")};WebLoader.prototype=new Loader(),WebLoader.prototype.parent=Loader,(WebLoader.prototype.constructor=WebLoader).prototype.name="WebLoader",WebLoader.prototype._ieLoadFile=function(pathname,sync,cb){var req=new ActiveXObject("MSXML2.XMLHTTP"),text=void 0;req.open("GET",this.protocol+pathname,!sync),sync||(req.onreadystatechange=function(){4===req.readyState&&(text=req.responseText,"function"==typeof cb&&cb(text))});try{req.send(),text=req.responseText}catch(e){text=void 0}return sync&&"function"==typeof cb&&cb(text),text},WebLoader.prototype._regularLoadFile=function(pathname,sync,cb){var req=new XMLHttpRequest(),text=void 0;pathname.substring(0,this.protocol.length)!==this.protocol&&(pathname=this.protocol+pathname),req.open("GET",pathname,!sync),req.onload=function(e){text=req.response,"function"==typeof cb&&cb(0===req.status||200===req.status?text:void 0)},req.onerror=function(err){text=void 0,"function"==typeof cb&&cb(void 0)};try{req.send()}catch(e){text=void 0,"function"==typeof cb&&cb(void 0)}return text},WebLoader.prototype.getProperPath=function(params){var loc,language,script,region,returnPath,dir,baseResDir="resources";if(params.name&&params)return params.locale&&(this.locale="string"==typeof params.locale?new Locale(params.locale):params.locale),params.name&&(this.name=params.name),params.baseResDir&&(baseResDir=params.baseResDir),language=(loc=this.locale||new Locale).getLanguage(),script=loc.getScript(),region=loc.getRegion(),this.listAvailableFiles(),language&&(dir=language+"/"+this.name,this.checkAvailability(dir)&&(returnPath=dir)),script&&(dir=language+"/"+script+"/"+this.name,this.checkAvailability(dir)&&(returnPath=dir)),region&&(dir=script?language+"/"+script+"/"+region+"/"+this.name:language+"/"+region+"/"+this.name,this.checkAvailability(dir)&&(returnPath=dir)),returnPath?baseResDir+"/"+returnPath:this.name},module.exports=WebLoader;