var ilib=require("../index.js"),SearchUtils=require("./SearchUtils.js"),MathUtils=require("./MathUtils.js"),Locale=require("./Locale.js"),LocaleInfo=require("./LocaleInfo.js"),IDate=require("./IDate.js"),TimeZone=require("./TimeZone.js"),GregorianCal=require("./GregorianCal.js"),GregRataDie=require("./GregRataDie.js"),GregorianDate=function(params){this.cal=new GregorianCal(),"boolean"==typeof(params=params||{}).noinstance&&params.noinstance||(params.timezone&&(this.timezone=params.timezone.toString()),params.locale&&(this.locale="string"==typeof params.locale?new Locale(params.locale):params.locale),this.timezone?this._init(params):this.locale?new LocaleInfo(this.locale,{sync:params.sync,loadParams:params.loadParams,onLoad:ilib.bind(this,function(li){this.li=li,this.timezone=li.getTimeZone(),this._init(params)})}):(this.timezone="local",this._init(params)))};GregorianDate.prototype=new IDate({noinstance:!0}),GregorianDate.prototype.parent=IDate,(GregorianDate.prototype.constructor=GregorianDate).prototype._init=function(params){var hBefore,d;params.year||params.month||params.day||params.hour||params.minute||params.second||params.millisecond?(this.year=parseInt(params.year,10)||0,this.month=parseInt(params.month,10)||1,this.day=parseInt(params.day,10)||1,this.hour=parseInt(params.hour,10)||0,this.minute=parseInt(params.minute,10)||0,this.second=parseInt(params.second,10)||0,this.millisecond=parseInt(params.millisecond,10)||0,"boolean"==typeof params.dst&&(this.dst=params.dst),this.rd=this.newRd(params),this.offset=0,"local"===this.timezone&&void 0===params.dst?(d=new Date(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond),hBefore=new Date(this.year,this.month-1,this.day,this.hour-1,this.minute,this.second,this.millisecond),this.offset=-d.getTimezoneOffset()/1440,d.getTimezoneOffset()<hBefore.getTimezoneOffset()?(d=-hBefore.getTimezoneOffset()/1440,this.rd=this.newRd({rd:this.rd.getRataDie()-d})):this.rd=this.newRd({rd:this.rd.getRataDie()-this.offset}),this._init2(params)):new TimeZone({id:this.timezone,sync:params.sync,loadParams:params.loadParams,onLoad:ilib.bind(this,function(tz){this.tz=tz,this.offset=this.tz._getOffsetMillisWallTime(this)/864e5,this.rd=this.newRd({rd:this.rd.getRataDie()-this.offset}),this._init2(params)})})):this._init2(params)},GregorianDate.prototype._init2=function(params){this.rd||(this.rd=this.newRd(params),this._calcDateComponents()),"function"==typeof params.onLoad&&params.onLoad(this)},GregorianDate.prototype.newRd=function(params){return new GregRataDie(params)},GregorianDate._calcYear=function(rd){var years400=Math.floor((rd-1)/146097),rd=MathUtils.mod(rd-1,146097),years100=Math.floor(rd/36524),rd=MathUtils.mod(rd,36524),years4=Math.floor(rd/1461),rd=MathUtils.mod(rd,1461),rd=Math.floor(rd/365),years400=400*years400+100*years100+4*years4+rd;return 4!==years100&&4!==rd&&years400++,years400},GregorianDate.prototype._calcYear=function(rd){return GregorianDate._calcYear(rd)},GregorianDate.prototype._calcDateComponents=function(){var d,cumulative;"local"===this.timezone&&-99280837<=this.rd.getRataDie()&&this.rd.getRataDie()<=100719163?(d=new Date(this.rd.getTimeExtended()),this.year=d.getFullYear(),this.month=d.getMonth()+1,this.day=d.getDate(),this.hour=d.getHours(),this.minute=d.getMinutes(),this.second=d.getSeconds(),this.millisecond=d.getMilliseconds(),this.offset=-d.getTimezoneOffset()/1440):(void 0===this.offset&&(this.year=this._calcYear(this.rd.getRataDie()),this.tz||(this.tz=new TimeZone({id:this.timezone})),this.offset=this.tz.getOffsetMillis(this)/864e5),d=this.rd.getRataDie(),0!==this.offset&&(d+=this.offset),this.year=this._calcYear(d),d=d-this.newRd({year:this.year,month:1,day:1,cal:this.cal}).getRataDie()+1,cumulative=GregorianCal.prototype.isLeapYear.call(this.cal,this.year)?GregRataDie.cumMonthLengthsLeap:GregRataDie.cumMonthLengths,this.month=SearchUtils.bsearch(Math.floor(d),cumulative),d-=cumulative[this.month-1],this.day=Math.floor(d),d-=this.day,d=Math.round(864e5*d),this.hour=Math.floor(d/36e5),d-=36e5*this.hour,this.minute=Math.floor(d/6e4),d-=6e4*this.minute,this.second=Math.floor(d/1e3),d-=1e3*this.second,this.millisecond=Math.floor(d))},GregorianDate.prototype.getDayOfWeek=function(){var rd=Math.floor(this.rd.getRataDie()+(this.offset||0));return MathUtils.mod(rd,7)},GregorianDate.prototype.getDayOfYear=function(){return(this.cal.isLeapYear(this.year)?GregRataDie.cumMonthLengthsLeap:GregRataDie.cumMonthLengths)[this.month-1]+this.day},GregorianDate.prototype.getEra=function(){return this.year<1?-1:1},GregorianDate.prototype.getCalendar=function(){return"gregorian"},IDate._constructors.gregorian=GregorianDate,module.exports=GregorianDate;