var ilib=require("../index.js"),SearchUtils=require("./SearchUtils.js"),MathUtils=require("./MathUtils.js"),Locale=require("./Locale.js"),LocaleInfo=require("./LocaleInfo.js"),TimeZone=require("./TimeZone.js"),IDate=require("./IDate.js"),PersianAlgoCal=require("./PersianAlgoCal.js"),PersAlgoRataDie=require("./PersAlgoRataDie.js"),PersianAlgoDate=function(params){this.cal=new PersianAlgoCal(),(params=params||{}).timezone&&(this.timezone=params.timezone),params.locale&&(this.locale="string"==typeof params.locale?new Locale(params.locale):params.locale),this.timezone?this._init(params):this.locale?new LocaleInfo(this.locale,{sync:params.sync,loadParams:params.loadParams,onLoad:ilib.bind(this,function(li){this.li=li,this.timezone=li.getTimeZone(),this._init(params)})}):(this.timezone="local",this._init(params)),this.rd||(this.rd=this.newRd(params),this._calcDateComponents())};PersianAlgoDate.prototype=new IDate({noinstance:!0}),PersianAlgoDate.prototype.parent=IDate,(PersianAlgoDate.prototype.constructor=PersianAlgoDate).prototype._init=function(params){params.year||params.month||params.day||params.hour||params.minute||params.second||params.millisecond?(this.year=parseInt(params.year,10)||0,this.month=parseInt(params.month,10)||1,this.day=parseInt(params.day,10)||1,this.hour=parseInt(params.hour,10)||0,this.minute=parseInt(params.minute,10)||0,this.second=parseInt(params.second,10)||0,this.millisecond=parseInt(params.millisecond,10)||0,this.dayOfYear=parseInt(params.dayOfYear,10),"boolean"==typeof params.dst&&(this.dst=params.dst),this.rd=this.newRd(this),new TimeZone({id:this.timezone,sync:params.sync,loadParams:params.loadParams,onLoad:ilib.bind(this,function(tz){this.tz=tz,this.offset=this.tz._getOffsetMillisWallTime(this)/864e5,0!==this.offset&&(this.rd=this.newRd({rd:this.rd.getRataDie()-this.offset})),this._init2(params)})})):this._init2(params)},PersianAlgoDate.prototype._init2=function(params){this.rd||(this.rd=this.newRd(params),this._calcDateComponents()),"function"==typeof params.onLoad&&params.onLoad(this)},PersianAlgoDate.prototype.newRd=function(params){return new PersAlgoRataDie(params)},PersianAlgoDate.prototype._calcYear=function(rd){var rd=rd-173126,numberOfCycles=Math.floor(rd/1029983),rd=MathUtils.mod(rd,1029983),numberOfCycles=474+2820*numberOfCycles+(1029982===rd?2820:Math.floor((2816*rd+1031337)/1028522));return 0<numberOfCycles?numberOfCycles:numberOfCycles-1},PersianAlgoDate.prototype._calcDateComponents=function(){var rd=this.rd.getRataDie(),yearStart=(this.year=this._calcYear(rd),void 0===this.offset&&(this.tz||(this.tz=new TimeZone({id:this.timezone})),this.offset=this.tz.getOffsetMillis(this)/864e5),0!==this.offset&&(rd+=this.offset,this.year=this._calcYear(rd)),this.newRd({year:this.year,month:1,day:1,hour:0,minute:0,second:0,millisecond:0})),rd=rd-yearStart.getRataDie()+1;this.dayOfYear=rd,this.month=SearchUtils.bsearch(rd,PersAlgoRataDie.cumMonthLengths),rd-=PersAlgoRataDie.cumMonthLengths[this.month-1],this.day=Math.floor(rd),rd-=this.day,rd=Math.round(864e5*rd),this.hour=Math.floor(rd/36e5),rd-=36e5*this.hour,this.minute=Math.floor(rd/6e4),rd-=6e4*this.minute,this.second=Math.floor(rd/1e3),rd-=1e3*this.second,this.millisecond=rd},PersianAlgoDate.prototype.getDayOfWeek=function(){var rd=Math.floor(this.getRataDie());return MathUtils.mod(rd-3,7)},PersianAlgoDate.prototype.getDayOfYear=function(){return PersAlgoRataDie.cumMonthLengths[this.month-1]+this.day},PersianAlgoDate.prototype.getEra=function(){return this.year<1?-1:1},PersianAlgoDate.prototype.getCalendar=function(){return"persian-algo"},IDate._constructors["persian-algo"]=PersianAlgoDate,module.exports=PersianAlgoDate;